
<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8" />
<meta name="generator" content="LaTeX lwarp package" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<!--[if lt IE 9]>
<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<title>Springhead - How to use CMake — Springheadを開発する方へ</title>
<link rel="stylesheet" type="text/css" href="lwarp_sagebrush.css" />
</head>
<body>


<a id="autopage-32"></a> <nav class="topnavigation"><a href="main_html.html" class="linkhome"
>Home</a></nav>

<header>

</header>

<h1>Springhead - How to use CMake</h1>
<nav class="sidetoc">

<div class="sidetoctitle">

<p>Contents</p>


</div>

<div class="sidetoccontents">

<p><a href="main_html.html" class="linkhome"
>Home</a></p>


<p><a href="2ukqrQFbNykczxHg.html#autosec-6" class="tocchapter"
><span class="sectionnumber">1</span>&#x2001;CMakeとは何をするものか</a></p>


<p><a href="2ukqrQFbNykczxHg.html#autosec-7" class="tocsection"
><span class="sectionnumber">1.1</span>&#x2001;CMakeとは何をするものか</a></p>


<p><a href="COtOfv3iniSnphzw.html#autosec-18" class="tocchapter"
><span class="sectionnumber">2</span>&#x2001;Springheadをライブラリとして利用する方へ</a></p>


<p><a href="COtOfv3iniSnphzw.html#autosec-19" class="tocsection"
><span class="sectionnumber">2.1</span>&#x2001;Springheadをライブラリとして利用する方へ</a></p>


<p><a href="2rgZt0T7lfFaxUHi.html#autosec-33" class="tocchapter"
><span class="sectionnumber">3</span>&#x2001;Springheadを開発する方へ</a></p>


<p><a href="2rgZt0T7lfFaxUHi.html#autosec-34" class="tocsection"
><span class="sectionnumber">3.1</span>&#x2001;Springheadを開発する方へ</a></p>


</div>

</nav>

<section class="textbody">

<h3 id="autosec-33"> <span class="sectionnumber">3&#x2001;</span>Springheadを開発する方へ</h3><a id="autopage-33"></a>

<a id="ForSpringheadDevelopper"></a>
<h4 id="autosec-34"> <span class="sectionnumber">3.1&#x2001;</span>Springheadを開発する方へ</h4><a id="autopage-34"></a>

<a id="sec:ForDevelopper"></a>

<p>この章では、Springheadの開発を行なう方のために、 cmakeを使用したアプリケーションプログラムの作成方法について説明します。</p>


<p>アプリケーションプログラムについての作業をする前に、 あらかじめSpringehadライブラリをダウンロードしてcmakeを実行しておいてください (“<a href="COtOfv3iniSnphzw.html#sec:ForNonDevelopper">2.1</a> Springheadをライブラリとして利用する方”参
照)。</p>
<h5 id="autosec-35"> <span class="sectionnumber">3.1.1&#x2001;</span>準備</h5><a id="autopage-35"></a>

<a id="subsec:PrepareApplication"></a>

<p>アプリケーションと並行してSpringheadライブラリを開発する場合には、 “<a href="2ukqrQFbNykczxHg.html#subsec:Problems">1.1.3</a> CMakeを使用した場合の問題点”で示した問題に対処する必要があるため、 ここで述べる方法に従って作業を進めてください
(“<a href="2ukqrQFbNykczxHg.html#subsec:Solution">1.1.4</a> 対処法”で示した方策が組み込まれます)。</p>


<p>以下、Springheadライブラリをダウンロードしたディレクトリを"C:/Springhead" 、 アプリケーションプログラムを作成するディレクトリを"C:/Develop/Application"として説明を進めます。</p>


<p>"C:/Develop/Application"に移動してください。</p>


<p>配布されたファイル"CMakeTopdir.txt.dist"を"CMakeTopdir.txt"という名前で、 "CMakeLists.txt.Dev.dist"を"CMakeLists.txt"という名前でコピーします (誤ってコミットするのを防ぐためにも、リネームではなくコピーしてください）
                                                                                                                                                       。</p>


<figure id="autoid-14" class="figure ">
<div class="center">

<p>
<a href="fig/command-3-1-a.svg" target="_blank"
><img src="fig/command-3-1-a.svg"
style="width:434pt; "
class="inlineimage"
></a></p>


</div>

<a id="fig:DownloadTree"></a>

</figure>

<p>"CMakeTopdir.txt"の編集         </p>


<ul style="list-style-type:none">

<li>
<p>Springheadライブラリをダウンロードしたディレクトリを"CMakeTopdir.txt"にはSpringheadライブラリに設定します。 これは、CMakeにSpringheadのソースツリーの場所を教えるために必要な設定です。</p>

<figure id="autoid-15" class="figure ">
<div class="center">
<p>
<a href="fig/command-3-1-b.svg" target="_blank"
><img src="fig/command-3-1-b.svg"
style="width:434pt; "
class="inlineimage"
></a></p>

</div>
<a id="fig:DownloadTree"></a>
</figure>
</li>
</ul>

<p>"CMakeLists.txt"の編集     </p>


<ul style="list-style-type:none">

<li>
<ul style="list-style-type:none">

<li>
<p>1. プロジェクト名を設定します(11行目)。</p>

<figure id="autoid-16" class="figure ">
<div class="center">
<p>
<a href="fig/command-3-1-b.svg" target="_blank"
><img src="fig/command-3-1-b.svg"
style="width:434pt; "
class="inlineimage"
></a></p>

</div>
<a id="fig:DownloadTree"></a>
</figure>
</li>
<li>
<p>2. Customization section (19行目以降)を必要に応じて変更します。<br />
各変数の意味は次のとおりです。</p>

<ul style="list-style-type:none">

<li>
<table>
<tr class="hline" >
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #">OOS_BLD_DIR</td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">CMakeの作業領域(ディレクトリ)の名前(本ドキュ</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">メントでbuild としているもの)。</td>
</tr>

<tr class="hline" >
<td colspan="2" class="tdl tvertbarl tvertbarr" style="border-left:   1px solid #; border-right:   1px solid #">CMAKE_CONFIGURATION_TYPES</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right:     1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">ビルド構成。</td>
</tr>

<tr class="hline" >
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #">SRCS</td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">ビルドの対象とするファイル。 設定はset(SRCS …)</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">またはfile(GLOB SRCS …)とします。</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">後者ではワイルドカードが使えます。</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">SRCSの直後に“RELATIVE &lt;base-dir &gt;”を付加すると</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">相対パス指定となります。デフォルトは</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #"> file(GLOB RELATIVE &dollar;{CMAKE_SOURCE_DIR} *.cpp *.h)</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right:     1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">です。</td>
</tr>

<tr class="hline" >
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #">EXCLUDE_SRCS</td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">ビルドの対象から外すファイル。</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">上のSRCSでRELATIVEとしていないときは絶対パス</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right:     1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">で指定します。</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">SRCSでワイルドカードを使用した場合に有用です。</td>
</tr>

<tr class="hline" >
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #">SPR_PROJS</td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">アプリケーションに組み込むSpringheadライブラリ</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right:     1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">のプロジェクト名。</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">不要なプロジェクト名を削除します。 この中にRun-</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">Swigを含めてはいけません。</td>
</tr>

<tr class="hline" >
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #">ADDITIONAL_INCDIR</td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">追加のインクルードパス指定。</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">現在のディレクトリは &dollar;{CMAKE_SOURCE_DIR}で参照</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right:     1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">できます。</td>
</tr>

<tr class="hline" >
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #">ADDITIONAL_LIBDIR</td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">追加のライブラリパス指定。</td>
</tr>

<tr class="hline" >
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #">ADDITIONAL_LIBS</td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">追加のライブラリファイル名。</td>
</tr>

<tr class="hline" >
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #">EXCLUDE_LIBS</td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">linkの対象から外すライブラリファイル名。</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">デフォルトで組み込まれてしまうライブラリファイル</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">を排除するために指定します。</td>
</tr>

<tr class="hline" >
<td class="tdl tvertbarl tvertbarr" style="border-left:   1px solid #; border-right:   1px solid #"> <td colspan="2" class="tdl tvertbarl tvertbarr" style="border-left:   1px solid #; border-right:   1px solid
#">DEBUGGER_WORKING_DIRECTORY</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #">                           </td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">Visual Studio Debuggerの作業ディレクトリ名。</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">デバッガはこのディレクトリで起動されたように振る</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right:     1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">舞います。</td>
</tr>

<tr class="hline" >
<td colspan="2" class="tdl tvertbarl tvertbarr" style="border-left:   1px solid #; border-right:   1px solid #">DEBUGGER_COMMAND_ARGUMENTS</td>
</tr>

<tr>
<td class="tdl tvertbarl tvertbarr" style="border-left: 1px solid #; border-right: 1px solid #"></td>
<td class="tdl tvertbarr" style="border-right: 1px solid #">Visual Studio Debuggerに渡すコマンド引数</td>
</tr>

<tr class="hline" >
<td class="tdl"></td>
<td class="tdl"></td>
</tr>
</table>
</li>
</ul>
</li>
</ul>
</li>
</ul>

<p>自前でインストールしているパッケージ (boost, glew, freeglut, glui)を使用する場合には、 さらに、 配布されたファイル"CMakeConf.txt.dist"を"CMakeConf.txt"という名前でコピーして 必要な編集をします。 “<a
href="Springheadをライブラリとして利用する方へ.html#subsec:PrepareLibrary">2.1.2</a> 準備”を参照してください。</p>


<p>ビルドの条件(compile/linkのパラメータ)を変更したいときは、 配布されたファイル"CMakeOpts.txt.dist"を"CMakeOpts.txt"という名前でコピーして 適宜変更してください。</p>


<p>以上で準備作業は終了です。</p>
<h5 id="autosec-40"> <span class="sectionnumber">3.1.2&#x2001;</span>cmakeの実行</h5><a id="autopage-40"></a>

<a id="subsec:CmakeApplication"></a>

<p>cmakeの実行手順については、 “<a href="COtOfv3iniSnphzw.html#subsec:CmakeLibrary">2.1.3</a> cmakeの実行”と同じですから、 そちらを参照してください。 ここでは、cmakeを実行することで “<a
href="CMakeとは何をするものか.html#subsec:Solution">1.1.4</a> 対処法”で示した対策がどのように実施されるかについて述べます。</p>


<p>ビルドの最適性         </p>


<ul style="list-style-type:none">

<li>
<p>組み込まれているSpringheadライブラリの各プロジェクト (ここではBaseを例にします)に対して<br />
<span style="width:20pt; display:inline-block"></span>"C:/Springhead/core/src/Base/&lt;x64&gt; /&lt;15.0&gt; /Base.dir"(*1)<br />
というディレクトリを作成し、 "C:/Develop/Application/build /Base/Base.dir"から上記ディレクトリ(*1)へ linkを張る作業をcmake configure時に(自動的に)行ないます。</p>

</li>
</ul>

<ul style="list-style-type:none">

<li>
<p><span style="background:black; width:867pt ; height:1pt ; display:inline-block;"></span><br />
これに関して皆さんが行なうべきことはありませんが、 次のことに注意してください。</p>

<ul style="list-style-type:none">

<li>
<p>1. cmakeをした後でSpringheadソースツリー上ので上記ディレクトリ (*1)を削除すると、以降のビルドで<br />
<span style="width:15pt; display:inline-block"></span>“エラー MSB3191 ディレクトリ"Base.dir/Debug/"を作成できません。”</p>

<p>というエラーが発生します。</p>

</li>
<li>
<p>2. Springheadライブラリ側でcmake (configure)を実行していないと オブジェクトの共通格納領域が作成されていないため、 前項と同じエラーが発生します。</p>

</li>
<li>
<p>3. アプリケーション側で"C:/Develop/Application/build /Base/Base.dir"を削除すると、 ビルド時にVisual Studioがbuild 下に"Base.dir"を 自動的に作成するためにビルドの最適性が崩れてしまいます (無駄なビルドが発生するだけで、ビルド自体は正常に行なえま
す)。    </p>

<ul style="list-style-type:none">

<li>
<p>Windowsでは実行権限の都合上linkをjunctionで実現していますが、 explorerでもcommand prompt上でも"Base.dir"がjunctionか 通常のディレクトリかの区別がつきません。 そのためこのような事態の発見が困難になる可能性があります。</p>

</li>
</ul>
</li>
</ul>
<p>これらの状態を解消するためには、アプリケーション側 (もしくはSpringheadライブラリ側)で再度cmakeを実行する必要があります。</p>

<p><span style="background:black; width:867pt ; height:1pt ; display:inline-block;"></span></p>

</li>
</ul>

<p>プロジェクトファイルの整合性               </p>


<ul style="list-style-type:none">

<li>
<p>“<a href="2ukqrQFbNykczxHg.html#subsec:Solution">1.1.4</a> 対処法”でも述べたように、 プロジェクトファイル(ソリューションファイルの含む。以下同様)は Springheadライブラリのビルドツリーにあるものを最新の状態に保つことを前提として、 アプリケーシ
ョン側のプロジェクトファイルは これらSpringhead側にあるものへのlinkとなるようにします。 このためにアプリケーションプログラムのソリューションに syncというターゲットを追加して、次の処理を実行させます。 </p>

<ul style="list-style-type:none">

<li>
<p>1. もしもアプリケーション側のプロジェクトファイルの内容と Springhead側のプロジェクトファイルの内容とが異なっていたならば、 アプリケーション側のプロジェクトファイルを Springhead側にコピーする。                            </p>

<ul style="list-style-type:none">

<li>
<p>これは、アプリケーション側でソースファイル構成を変更 (ファイルの追加・削除)を行ない、 Visual Studio上でプロジェクトファイルを保存したとき、 またはアプリケーション側で再度cmakeを実行したときです。</p>

</li>
</ul>
</li>
<li>
<p>2. アプリケーション側のプロジェクトファイルをSpringhead側の プロジェクトファイルへのlinkとする。</p>

</li>
</ul>
<p>ターゲットsyncはアプリケーションのビルドにおいて 必ず最初に実行されるように依存関係が設定されます。</p>

</li>
</ul>

<ul style="list-style-type:none">

<li>
<p><span style="background:black; width:867pt ; height:1pt ; display:inline-block;"></span><br />
次のことに注意してください。</p>

<ul style="list-style-type:none">

<li>
<p>1. Springhead側または他のアプリケーションが実施した変更は、 アプリケーションをビルドするだけで自動的に反映されます。</p>

</li>
<li>
<p>2. 自アプリケーションで実施したソース構成の変更は、 ビルドを実施した時点でSpringhead側に反映されます。 つまり、プロジェクトファイルの整合性を保つためには、 ソース構成の変更後に少なくとも1回はビルドを実行する必要がある ということです(syncの実行
だけでもよい)。    </p>

<ul style="list-style-type:none">

<li>
<p>ソース構成を変更したらビルドするでしょうから、 このことが問題になることはほとんどないと思われます。</p>

<p>もしSpringhead側でプロジェクトファイルが削除されたならば、 ビルドエラー(syncでlink先のファイルが見つからない) となります。</p>

<p>この場合にはSpringhead側で再度cmakeを実行する必要があります (アプリケーション側では駄目)。</p>

</li>
</ul>
</li>
<li>
<p>3. syncターゲットが実行されるとプロジェクトファイルが更新される ことがあるため、“プロジェクトが環境外で変更された”旨の メッセージが出ることがあります。 「すべて再読み込み」としてください。</p>

</li>
</ul>
<p><span style="background:black; width:867pt ; height:1pt ; display:inline-block;"></span></p>

</li>
</ul>
<h5 id="autosec-41"> <span class="sectionnumber">3.1.3&#x2001;</span>アプリケーションプログラムのビルド</h5><a id="autopage-41"></a>

<a id="subsec:BuildApplication"></a>

<p>アプリケーションのビルドは従来と変わりがありませんが、 ソリューションに新しいターゲット ALL_BUILD, syncが追加されています。 ここでは、これらについて説明します。</p>


<p>ALL_BUILD        </p>


<ul style="list-style-type:none">

<li>
<p>これはcmakeが自動的に作成するターゲットでmake allに相当するものと されています。ただしVisual Studio上ではALL_BUILDの依存関係の設定が不正確で、 このターゲットをビルドしても正しい結果は得られないようです。 このターゲットは無視してくださ
い</p>

</li>
</ul>

<p>sync    </p>


<ul style="list-style-type:none">

<li>
<p>これは“<a href="2rgZt0T7lfFaxUHi.html#subsec:CmakeApplication">3.1.2</a> cmakeの実行”で述べたとおり、 プロジェクトファイルの整合性を保つために作られたものです。 Springheadライブラリのプロジェクトを一つでもビルドすれば このターゲットは必ず
最初に実行されますから、 このターゲットに対して何らかのアクションを起こす必要はないでしょう。</p>

</li>
</ul>

<p><span style="background:black; width:867pt ; height:1pt ; display:inline-block;"></span> 補足   </p>


<ul style="list-style-type:none">

<li>
<p>2019/9/30 (commit 1d8e5ce)以前に配布した"CMakeLists.txt.*.dist"を元に "CMakeLists.txt"を作成して使用している場合</p>

<p>RunSwigでclean/rebuildの対応ができていなかったため、 cleanと同等の機能を実現するためのターゲットRunSwig_Cleanが作成されて いるはずです。</p>

<p>上記日付以降のSpringheadライブラリをダウンロードしcmakeを実行していただければ、 RunSwigはclean/rebuild対応となります。 ただし、RunSwig_Cleanをビルドすると            </p>

<ul style="list-style-type:none">

<li>
<p>python: can’t open file ’.../Clean.py’: ... No such file ...</p>

</li>
</ul>
<p>というエラーが起きます。実害はありませんがRunSwigのcleanは行なわれません。</p>

<p> RunSwig_Cleanターゲットを生成されないようにするには、 新しい配布ファイルから"CMakeLists.txt"を再作成するか、 または既存の"CMakeLists.txt"から以下の部分を削除して再cmakeしてください。</p>

<ul style="list-style-type:none">

<li>
<figure id="autoid-17" class="figure ">
<ul style="list-style-type:none">

<li>
<div class="center">
<p><span class="fbox" style="border:1pt solid black ; padding:3pt">
<a href="fig/RemoveRunSwigClean.svg" target="_blank"
><img src="fig/RemoveRunSwigClean.svg"
style="width:347pt; "
class="inlineimage"
></a> </span></p>

</div>
<a id="fig:SpringheadLibraryTree"></a>
</li>
</ul>
</figure>
</li>
</ul>
<p>EmbPython_RunSwig_Cleanについても同様です。</p>

</li>
</ul>
</section>

<footer>

</footer>

<nav class="botnavigation"><a href="main_html.html" class="linkhome"
>Home</a></nav>

</body>
</html>
