
<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="UTF-8" />
<meta name="generator" content="LaTeX lwarp package" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<!--[if lt IE 9]>
<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<title>Springhead - How to use CMake — CMakeとは何をするものか</title>
<link rel="stylesheet" type="text/css" href="lwarp_sagebrush.css" />
</head>
<body>


<a id="autopage-5"></a> <nav class="topnavigation"><a href="main_html.html" class="linkhome"
>Home</a></nav>

<header>

</header>

<h1>Springhead - How to use CMake</h1>
<nav class="sidetoc">

<div class="sidetoctitle">

<p>Contents</p>


</div>

<div class="sidetoccontents">

<p><a href="main_html.html" class="linkhome"
>Home</a></p>


<p><a href="2ukqrQFbNykczxHg.html#autosec-6" class="tocchapter"
><span class="sectionnumber">1</span>&#x2001;CMakeとは何をするものか</a></p>


<p><a href="2ukqrQFbNykczxHg.html#autosec-7" class="tocsection"
><span class="sectionnumber">1.1</span>&#x2001;CMakeとは何をするものか</a></p>


<p><a href="COtOfv3iniSnphzw.html#autosec-18" class="tocchapter"
><span class="sectionnumber">2</span>&#x2001;Springheadをライブラリとして利用する方へ</a></p>


<p><a href="COtOfv3iniSnphzw.html#autosec-19" class="tocsection"
><span class="sectionnumber">2.1</span>&#x2001;Springheadをライブラリとして利用する方へ</a></p>


<p><a href="2rgZt0T7lfFaxUHi.html#autosec-33" class="tocchapter"
><span class="sectionnumber">3</span>&#x2001;Springheadを開発する方へ</a></p>


<p><a href="2rgZt0T7lfFaxUHi.html#autosec-34" class="tocsection"
><span class="sectionnumber">3.1</span>&#x2001;Springheadを開発する方へ</a></p>


</div>

</nav>

<section class="textbody">

<h3 id="autosec-6"> <span class="sectionnumber">1&#x2001;</span>CMakeとは何をするものか</h3><a id="autopage-6"></a>

<a id="WhatCMakeWillDo"></a>
<h4 id="autosec-7"> <span class="sectionnumber">1.1&#x2001;</span>CMakeとは何をするものか</h4><a id="autopage-7"></a>

<a id="sec:WhatCMakeWillDo"></a>

<p>最初にCmakeとは何をするものかについて簡単に説明をします。 Springheadの開発に携わらない方はこの章の内容は不要です。 “<a href="COtOfv3iniSnphzw.html#sec:ForNonDevelopper">2.1</a> Springheadをライブラリとして利用する方へ”をお読みください。
また、Cmakeについて理解をされている方は “<a href="2ukqrQFbNykczxHg.html#subsec:Problems">1.1.3</a> CMakeを使用した場合の問題点”、 “<a href="CMakeとは何をするものか.html#subsec:Solution">1.1.4</a> 対処法”および “<a
href="Springheadを開発する方へ.html#sec:ForDevelopper">3.1</a> Springheadを開発する方へ”をお読みください。</p>
<h5 id="autosec-8"> <span class="sectionnumber">1.1.1&#x2001;</span>従来の方法</h5><a id="autopage-8"></a>

<a id="subsec:ConventionalMethod"></a>

<p>GitHubからSpringheadをダウンロードすると、 Springheadライブラリをビルドするためのソリューションファイル およびプロジェクトファイルがその中に含まれています。</p>


<ul style="list-style-type:none">

<li>
<figure id="autoid-1" class="figure ">
<div class="center">
<p>
<a href="fig/DownloadTree.svg" target="_blank"
><img src="fig/DownloadTree.svg"
style="width:390pt; "
class="inlineimage"
></a></p>

</div>
<a id="fig:DownloadTree"></a>
</figure>
</li>
</ul>

<p>上記のソリューションファイル[*1]を実行すればSpringheadライブラリを生成することができ、 アプリケーションプログラム用のソリューションファイルに 上記のプロジェクトファイル[*2]を“既存のプロジェクト”として追加すれば、 アプリケーションとSpringheadラ
イブラリの開発を同時に行なうことができました。</p>


<p>後者の場合は、プロジェクトファイル[*2]は直接共有されることになります。 このため、複数のソリューションファイルを同時に開き、あるアプリケーションで プロジェクトファイル[*2]に変更が及ぶような修正(ソースファイルの追加・削除)を実施しても、 その変更は
他のアプリケーションに直ちに反映されました。 (プロジェクトが環境外で変更された旨のダイアログが出ます）</p>


<p>この方法はうまく機能していますが、次の点が難点として挙げられます。</p>


<ul style="list-style-type:none">

<li>
<p>• Visual Studioのバージョンが変わる度に、 ソリューションファイルとプロジェクトファイルを作り直す必要がある。</p>

</li>
<li>
<p>• Windows以外のプラットフォームに対しては、 Makefileなどを別途作成する必要がある。</p>

</li>
</ul>
<h5 id="autosec-10"> <span class="sectionnumber">1.1.2&#x2001;</span>CMakeを使用した場合</h5><a id="autopage-10"></a>

<a id="subsec:WhenUsedCMake"></a>

<p>CMakeは、Visual Studioやmakeのように ソースコードのビルドやデバッグの制御をすることを目的としたツールではなく、 ビルドの自動化を図るためのツールです。 CMakeは、"CMakeLists.txt"というパラメータファイルから solution/project file (Windows
Visual Studio)やMakefile (unix make)を自動的に生成します (unixのconfigureに近いものと考えていただいてよいでしょう)。</p>


<p>Cmakeはout of source (out of place)によるビルドに対応しています。 これはソースツリーの「外側」にビルドツリーを生成する機能で、次のような特徴があります。</p>


<ul style="list-style-type:none">

<li>
<p>• 互いに干渉しない複数のビルドツリーを作成することができる。</p>

</li>
<li>
<p>• ビルドツリーが削除されてもソースツリーに影響が及ばない。</p>

</li>
</ul>

<p>我々はCMakeをout of sourceの方法で使用します。</p>


<p>ソースツリーおよびビルドツリーは次のようになるでしょう (図<a href="2rgZt0T7lfFaxUHi.html#fig:SpringheadLibraryTree">??</a>および図<a href="CMakeとは何をするものか.html#fig:ApplicationTree">1.2</a>)。</p>


<ul style="list-style-type:none">

<li>
<figure id="autoid-2" class="figure ">
<div class="center">
<p>
<a href="fig/LibraryTree.svg" target="_blank"
><img src="fig/LibraryTree.svg"
style="width:390pt; "
class="inlineimage"
></a></p>

</div>
<figcaption>
<p>Fig.                                         1.1:&nbsp;Springhead   Library構   成</p>

</figcaption>
<a id="fig:SpringheadLibraryTree"></a>
</figure>
</li>
</ul>

<ul style="list-style-type:none">

<li>
<figure id="autoid-3" class="figure ">
<div class="center">
<p>
<a href="fig/ApplicationTree.svg" target="_blank"
><img src="fig/ApplicationTree.svg"
style="width:390pt; "
class="inlineimage"
></a></p>

</div>
<figcaption>
<p>Fig.                                                    1.2:&nbsp;Application構   成</p>

</figcaption>
<a id="fig:ApplicationTree"></a>
</figure>
</li>
</ul>

<p>"CMakeLists.txt"はメインディレクトリおよびサブディレクトリのそれぞれに作成します。</p>
<h5 id="autosec-13"> <span class="sectionnumber">1.1.3&#x2001;</span>CMakeを使用した場合の問題点</h5><a id="autopage-13"></a>

<a id="subsec:Problems"></a>

<p>前節の図<a href="2ukqrQFbNykczxHg.html#fig:ApplicationTree">1.2</a>に示したような アプリケーションApp1 の他にアプリケーションApp2 があったとして、 その両方を同時に開いて作業を行なう場合を考えます。 ここではApp1 とApp2 が共通して参照す
るSpringheadライブラリのプロジェクトについてのみ考えます。</p>


<p>ソースファイルの整合性            </p>


<ul style="list-style-type:none">

<li>
<p>ソースファイルの整合性には問題がありません。 App1 とApp2 のどちらもSpringheadライブラリのソースツリーを指すようにしてありますから、 どちらで実施したソースファイルの変更も直ちに他方に反映されることになります。 (同じファイルを参照しているのです
から当然です)</p>

<p> ソースファイルの追加や削除を実施したとしても ソースファイルの整合性自体が崩れるわけではありません。 ただし、この場合には“プロジェクトファイルの整合性”の問題が発生します。</p>

</li>
</ul>

<p>ビルドの最適性(無駄なコンパイル)                </p>


<ul style="list-style-type:none">

<li>
<p>App1 とApp2 のビルドツリーは異なるものですから、 App1 でソースを変更してビルドしたとしても そのビルド結果(オブジェクトファイル)がそのままApp2 に反映されることはありません。 これらは異なるファイルです。</p>

                                                                                                    。 従来はオブジェクトファイルも共有されていましたから、 このよ
<p> App2 でソースの変更を反映させようとすれば App2 で再ビルドを行なう必要があります (この時点で変更されている ソースファイルが再コンパイルされ、オブジェクトファイルの整合性がとれます）
うな無駄なコンパイルは発生しませんでした。</p>

</li>
</ul>

<p>プロジェクトファイルの整合性                </p>


<ul style="list-style-type:none">

<li>
<p>ソースファイルの内容を修正しただけならば プロジェクトファイルが変更されることはありません。 しかし、ソースファイルの追加や削除を行なったならば プロジェクトファイルにも変更が及びます (Visual Studio上でソースの追加・削除を行なってセーブを行なった
場合、 もしくはApp1 での変更後に再cmakeを行なった場合)。</p>

<p> プロジェクトファイルもオブジェクトファイルと同様に ビルドツリー内に生成されますから、 App1 で実施した変更がApp2 に反映されることはありません。 しかもApp2 で再ビルドしたとしてもApp1 での変更が反映されることはありません。 App2 のプロジェク
トファイルはApp1 のものとは異なるファイルですから App2 は依然として古い状態を残したままなのです。</p>

<p> これを解消するにはApp2 で再度cmakeを実行する必要がありますが、 問題は“いつ再cmakeが必要なのかが分からない”ということです。</p>

</li>
</ul>
<h5 id="autosec-14"> <span class="sectionnumber">1.1.4&#x2001;</span>対処法</h5><a id="autopage-14"></a>

<a id="subsec:Solution"></a>

<p>前節で示した問題点への対処法について述べます。</p>


<p>ソースファイルの整合性            </p>


<ul style="list-style-type:none">

<li>
<p>Springheadライブラリのソースツリーにあるプロジェクトディレクトリ (Base, Collision, ...)を 直接‘add_subdirectory’すれば問題ありません。</p>

</li>
</ul>

<p>ビルドの最適性(無駄なコンパイル)                </p>


<ul style="list-style-type:none">

<li>
<p>Springheadライブラリ, App1, App2 などのすべてにおいて、 ライブラリのオブジェクトが生成される場所を共通化してしまうことで この問題を回避することとします。 具体的には、Springheadライブラリソースツリーの中(ビルドツリーの外)に オブジェクトの共通
格納場所を作り、 Springheadライブラリおよびすべてのアプリケーションのオブジェクト格納領域が そこを指すようにlinkを張ることとします。</p>

<figure id="autoid-4" class="figure ">
<div class="center">
<p>
<a href="fig/ApproachToBuildOptimization.svg" target="_blank"
><img src="fig/ApproachToBuildOptimization.svg"
style="width:390pt; "
class="inlineimage"
></a></p>

</div>
<figcaption>
<p>Fig.                        1.3:&nbsp;ビ                ル     ド   の      最           適           性          へ     の   対   処        法</p>

</figcaption>
<a id="fig:ApproachToBuildOptimization"></a>
</figure>
<p>オブジェクトの共通格納領域を設定する作業はSpringheadライブラリのcmake (configure)時に、 linkを張る作業はアプリケーションのcmake (configure)時に行なうものとします。</p>

</li>
</ul>

<p>プロジェクトファイルの整合性               </p>


<ul style="list-style-type:none">

<li>
<p>ビルドの最適性の場合と同様、 プロジェクトファイルも共通化することでこの問題に対処します。 具体的には、すべてのアプリケーションのプロジェクトファイルは、 Springheadライブラリビルドツリーにあるプロジェクトファイルを参照するlinkとします。</p>

<p> ただしこれでは不完全で、App1 で実施したプロジェクトファイルへの変更が App2 に伝わりません。 このためApp1 でプロジェクトファイルを変更した場合には、 その変更をSpringheadライブラリビルドツリーにあるプロジェクトファイルに反映させるものとしま
す。 つまり、Springheadライブラリのビルドツリーにあるプロジェクトファイルを 常に最新の状態に保つということです。</p>

<p> この作業はアプリケーションのビルド時に行なうものとします。 そのために、各アプリケーションのソリューションファイルに 特別なターゲット‘sync’を作成し、 このターゲットが毎回のビルドに先立って実行されるようにします。</p>

<figure id="autoid-5" class="figure ">
<div class="center">
<p>
<a href="fig/ApproachToProjfileOptimization.svg" target="_blank"
><img src="fig/ApproachToProjfileOptimization.svg"
style="width:390pt; "
class="inlineimage"
></a></p>

</div>
<figcaption>
<p>Fig.              1.4:&nbsp;プ          ロ          ジ             ェ   ク   ト   フ   ァ   イ   ル   の   最   適   性   へ   の   対   処   法</p>

</figcaption>
<a id="fig:ApproachToProjfileOptimization"></a>
</figure>
<p></p>

</li>
</ul>

</section>

<footer>

</footer>

<nav class="botnavigation"><a href="main_html.html" class="linkhome"
>Home</a></nav>

</body>
</html>
