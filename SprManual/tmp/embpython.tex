% ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----
%
% \KLUDGE ＜ドキュメントの書き方＞

% \KLUDGE 機能 ::= "\KLUDGE 概説" \KLUDGE 例 \KLUDGE 詳細 \KLUDGE リファレンス*
% \KLUDGE 例   ::= ["\KLUDGE コード例" "\KLUDGE コード例の説明"]*
% \KLUDGE 詳細 ::= [\KLUDGE 機能]*

% \KLUDGE リファレンス ::= [\KLUDGE ディスクリプタ | \KLUDGE インタフェース]

% - \KLUDGE 原則としてリファレンスは機能のまとめと補遺にとどめる．
% - Getter/Setter\KLUDGE は対応するディスクリプタのリファレンスに書き，インタフェースのリファレンスには載せない．
% - \KLUDGE 図は "\KLUDGE 概説" "\KLUDGE コード例" "\KLUDGE コード例の説明" \KLUDGE で適宜用いる．ただし "\KLUDGE コード例" \KLUDGE の図は原則としてそのコードの実行結果とする．

%
% ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----


% ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----
%
% \KLUDGE 概説
% 
\begin{chapterabstract}
EmbPython\KLUDGE モジュールは，スクリプト言語Python\KLUDGE との連携機能を提供します．Python\KLUDGE インタプリタからSpringhead\KLUDGE の機能を呼び出したり，Springhead\KLUDGE アプリケーションにPython\KLUDGE インタプリタを組み込んでスクリプティングエンジンとして使用するといった事ができます．

EmbPython\KLUDGE モジュールの使用により，Python\KLUDGE インタプリタ上にSpringhead API\KLUDGE クラスへのインタフェースクラスが提供されます．ユーザはPython\KLUDGE インタフェースクラスを使用してSpringhead\KLUDGE の各機能にアクセスします．Python\KLUDGE インタフェースクラスは内部的にSpringhead\KLUDGE の機能を呼び出し，結果をPython\KLUDGE インタフェースクラスに変換して返します．
\end{chapterabstract}

% ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----
%
% \KLUDGE 詳細１
% 
\section{\KLUDGE 利用法}

\KLUDGE 大きく分けて二通りの利用法を想定しています．

\KLUDGE 一つは，C++\KLUDGE で実装されたSpringhead\KLUDGE アプリケーションに対し，Python\KLUDGE インタプリタを組み込むことです．Springhead\KLUDGE アプリケーションの機能の一部をPython\KLUDGE スクリプト記述し，拡張性を高めます．

\KLUDGE もう一つは，Python\KLUDGE インタプリタに対する外部拡張モジュール(Python DLL, pyd)\KLUDGE として提供されたSpringhead\KLUDGE を利用することで，Python\KLUDGE アプリケーションにSpringhead\KLUDGE の機能を組み込む利用法です．

\KLUDGE どちらの場合においても，EmbPython\KLUDGE モジュールはPython\KLUDGE 側からSpringhead\KLUDGE の関数を呼び出すためのインタフェースを提供します．関係を\Fig{epoverview}\KLUDGE に示します．

\begin{fig}
\epscapopt{epoverview}{Python\KLUDGE 連携とEmbPython\KLUDGE モジュールの位置づけ}{width=0.8\hsize}
\end{fig}

\subsection{\KLUDGE 環境変数PATH\KLUDGE の設定}

Springhead\KLUDGE の動作は、\path{Springhead2\core\bin\win64}\KLUDGE フォルダ、および\path{Springhead2\dependency\bin\win64}\KLUDGE フォルダ内のdll\KLUDGE 群に依存しています。これらのフォルダの絶対パスを環境変数PATH\KLUDGE に追加してください。


% ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- 
% \KLUDGE 詳細a
\subsection*{Springhead\KLUDGE へのPython\KLUDGE 組込み}

Springhead\KLUDGE アプリケーションにPython\KLUDGE インタプリタを組み込んで利用する方法を解説します．
\KLUDGE 本節ではまずSpringhead\KLUDGE に同梱されたPython\KLUDGE インタプリタ組み込みサンプルを紹介し，簡単な使い方を説明します．その後，サンプルにおけるPython\KLUDGE インタプリタ組み込みのためのソースコードについて解説します．

\subsubsection*{PythonSpr\KLUDGE サンプルのビルドと実行}

Python\KLUDGE インタプリタ組み込みサンプルは \path{src\Samples\EmbPython\PythonSpr} \KLUDGE にあります．
\KLUDGE ビルドすると \path{PythonSpr.exe} \KLUDGE ができます．

\texttt{PythonSpr}\KLUDGE サンプルは標準的なSpringhead\KLUDGE サンプルアプリケーションフレームワークにPython\KLUDGE インタプリタを組み込んだもので，物理シーンを構築・シミュレーション・描画する事ができます．Python\KLUDGE インタプリタからは\texttt{phSdk}\KLUDGE や\texttt{fwSdk}\KLUDGE にアクセスすることができ，表示機能を切り替えたりシーンにオブジェクトを作成したりといったことがPython\KLUDGE から行えます．

\KLUDGE 実行の前に，環境変数を設定します．これは，Springhead\KLUDGE アプリケーションに組み込まれたPython\KLUDGE インタプリタがPython\KLUDGE の標準ライブラリ群にアクセスするために必要です．
\begin{description}
\item[\texttt{SPRPYTHONPATH}\KLUDGE 環境変数]~

Springhead\KLUDGE リリースを展開したフォルダ内の\path{bin\src\Python32\Lib}\KLUDGE へのフルパスを指定します．Python3.2\KLUDGE を\path{c:\Python32}\KLUDGE にインストールしてある場合，\path{C:\Python32\Lib}\KLUDGE でもかまいません．
\end{description}

\path{PythonSpr.exe}\KLUDGE を実行すると次のような画面が現れます．

\KLUDGE ＜スクリーンショット＞

\KLUDGE 右がSpringhead\KLUDGE の実行画面，左のコンソールがPython\KLUDGE プロンプトです．起動時には，Springhead\KLUDGE 実行画面には何のシーンも構築されていないため，ワールド座標系を示す矢印のみが描画されています．

\KLUDGE 操作法は以下の通りです．
\begin{description}
\item[\KLUDGE マウス \KLUDGE 左ドラッグ] \KLUDGE 視点変更（回転）
\item[\KLUDGE マウス \KLUDGE 右ドラッグ] \KLUDGE 視点変更（拡大縮小）
\item[\KLUDGE スペースキー] \KLUDGE シミュレーション開始・一時停止（起動直後は停止しています）
\end{description}

\subsubsection*{PythonSpr\KLUDGE サンプルの遊び方}

\KLUDGE この節では，Python\KLUDGE コードを中心としてSpringhead\KLUDGE の機能を利用する具体的な方法を紹介します．Python\KLUDGE からのSpringhead API\KLUDGE 利用に関する詳しい仕様は\SECTION{pythonsprAPI}\KLUDGE を参照してください．

Python\KLUDGE プロンプト上にSpringhead\KLUDGE のコードを入力して実行することができます．以下のように入力してシミュレーションを開始（スペースキー）すると，剛体が作成されて落ちていきます．
\begin{sourcecode}
# 剛体が落ちるだけのサンプル

>>> fwScene   ← 初期状態で定義されている変数で，アプリケーションが保持するfwSceneにアクセスできます
<Framework.FWScene object at 0x05250A40>
>>> phScene = fwScene.GetPHScene()
>>> desc = Spr.PHSolidDesc()
>>> desc.mass = 2.0
>>> solid0 = phScene.CreateSolid(desc)
\end{sourcecode}

\KLUDGE 形状を与えることもできます．なお，最後の行の\texttt{solid0.AddShape(box0)}\KLUDGE を実行するまで剛体に形状は割り当てられないので，この行を入力し終わるまではスペースキーを押さずにシミュレーションを一時停止状態にしておくとよいでしょう．
\begin{sourcecode}
# 形状のある剛体が落ちるだけのサンプル

>>> phScene = fwScene.GetPHScene()
>>> phSdk   = phScene.GetSdk()
>>> descSolid = Spr.PHSolidDesc()
>>> solid0 = phScene.CreateSolid(descSolid)
>>> descBox = Spr.CDBoxDesc()
>>> descBox.boxsize = Spr.Vec3f(1,2,3)
>>> box0 = phSdk.CreateShape(Spr.CDBox.GetIfInfoStatic(), descBox)
>>> solid0.AddShape(box0)
\end{sourcecode}

\KLUDGE 床（位置が固定された剛体）を作成すると，さらにそれらしくなります．
\begin{sourcecode}
>>> phScene = fwScene.GetPHScene()
>>> phSdk   = phScene.GetSdk()

# 床をつくる
>>> descSolid = Spr.PHSolidDesc()
>>> solid0 = phScene.CreateSolid(descSolid)
>>> descBox = Spr.CDBoxDesc()
>>> descBox.boxsize = Spr.Vec3f(10,2,10)
>>> boxifinfo = Spr.CDBox.GetIfInfoStatic()
>>> solid0.AddShape(phSdk.CreateShape(boxifinfo, descBox))
>>> solid0.SetFramePosition(Spr.Vec3d(0,-1,0))
>>> solid0.SetDynamical(False)

# 床の上に箱をつくって載せる
>>> solid1 = phScene.CreateSolid(descSolid)
>>> descBox.boxsize = Spr.Vec3f(1,1,1)
>>> boxifinfo = Spr.CDBox.GetIfInfoStatic()
>>> solid1.AddShape(phSdk.CreateShape(boxifinfo, descBox))
\end{sourcecode}

\KLUDGE 力を加えることもできます．
\begin{sourcecode}
>>> solid1.AddForce(Spr.Vec3d(0,200,0))
\end{sourcecode}

Python\KLUDGE のFor\KLUDGE やWhile\KLUDGE を使って継続して力を加えることもできます．
\begin{sourcecode}
>>> import time
>>> for i in range(0,100):
>>>     solid1.AddForce(Spr.Vec3d(0,20,0))
>>>     time.sleep(0.01)
\end{sourcecode}

\KLUDGE 応用として，簡単な制御ループを走らせることもできます．
\begin{sourcecode}
>>> import time
>>> for i in range(0,500):
>>>   y  = solid1.GetPose().getPos().y
>>>   dy = solid1.GetVelocity().y
>>>   kp = 20.0
>>>   kd =  3.0
>>>   solid1.AddForce(Spr.Vec3d(0, (2.0 - y)*kp - dy*kd, 0))
>>>   time.sleep(0.01)
\end{sourcecode}

\KLUDGE ここまでは剛体のみでしたが，関節も作成できます．
\begin{sourcecode}
>>> phScene = fwScene.GetPHScene()
>>> phSdk   = phScene.GetSdk()

>>> descSolid = Spr.PHSolidDesc()
>>> solid0 = phScene.CreateSolid(descSolid)
>>> descBox = Spr.CDBoxDesc()
>>> descBox.boxsize = Spr.Vec3f(1,1,1)
>>> boxifinfo = Spr.CDBox.GetIfInfoStatic()
>>> solid0.AddShape(phSdk.CreateShape(boxifinfo, descBox))
>>> solid0.SetDynamical(False)

>>> solid1 = phScene.CreateSolid(descSolid)
>>> solid1.AddShape(phSdk.CreateShape(boxifinfo, descBox))

>>> descJoint = Spr.PHHingeJointDesc()
>>> descJoint.poseSocket = Spr.Posed(1,0,0,0, 0,-1,0)
>>> descJoint.posePlug   = Spr.Posed(1,0,0,0, 0, 1,0)
>>> hingeifinfo = Spr.PHHingeJoint.GetIfInfoStatic()
>>> joint = phScene.CreateJoint(solid0, solid1, hingeifinfo, descJoint)
\end{sourcecode}


PythonSpr.exe\KLUDGE に引数を与えると，python\KLUDGE ファイルを読み込んで実行することもできます．ここまでに書いた内容を \texttt{test.py} \KLUDGE というファイルに書いて保存し，コマンドプロンプトから以下のように実行すると，test.py\KLUDGE に書いた内容が実行されます（スペースキーを押すまでシミュレーションは開始されないことに注意してください）．
\begin{sourcecode}
C:\src\Samples\EmbPython\PythonSpr> Release\PythonSpr.exe test.py
>>>
\end{sourcecode}


\subsubsection*{Python\KLUDGE インタプリタ組み込みのためのコード例}

PythonSpr\KLUDGE サンプルにおいて，Python\KLUDGE インタプリタを組み込むためのコードについて紹介します．

\begin{tips}
Python\KLUDGE インタプリタ組み込みの詳細を理解するためにはSpringhead\KLUDGE だけでなくPython\KLUDGE のC\KLUDGE 言語API\KLUDGE について知る必要があります．詳しく知りたい方はPython/C API\KLUDGE リファレンスマニュアル$^{*1}$\KLUDGE 等も参照してください．

{\footnotesize *1 ... \url{http://docs.python.org/py3k/c-api/index.html}}
\end{tips}

PythonSpr\KLUDGE サンプルにおいて，Python\KLUDGE 組み込みのためのコードは \texttt{main.cpp} \KLUDGE に記述されています．
\KLUDGE 関連箇所を抜粋して紹介します．

Python\KLUDGE 組み込み関連の機能を使用するには，\texttt{EmbPython.h} \KLUDGE ヘッダをインクルードします．
\begin{sourcecode}
#include <EmbPython/EmbPython.h>
\end{sourcecode}

Python\KLUDGE インタプリタは，Springhead\KLUDGE アプリケーション本体とは異なるスレッドで動作します．物理シミュレーションステップの実行中や描画の最中にPython\KLUDGE がデータを書き換えてしまうことがないよう，排他ロックをかけて保護します．
\begin{sourcecode}
virtual void OnStep(){
  UTAutoLock critical(EPCriticalSection);
  ...
}
virtual void OnDraw(GRRenderIf* render) {
  UTAutoLock critical(EPCriticalSection);
  ...
}
virtual void OnAction(int menu, int id){
  UTAutoLock critical(EPCriticalSection);
  ...
}
\end{sourcecode}
\texttt{EPCriticalSection}\KLUDGE はアプリケーションに一つしか存在しないインスタンスで，\texttt{EPCriticalSection}\KLUDGE による排他ロックを取得できるのは全アプリケーション中で一つのスコープのみです．Python\KLUDGE からSpringhead\KLUDGE の機能が呼び出される際には必ず\texttt{EPCriticalSection}\KLUDGE の取得を待つようになっているので，排他ロックを取得した\texttt{OnStep}\KLUDGE の実行中にPython\KLUDGE がSpringhead\KLUDGE の機能を実行することはありません\footnote{\KLUDGE ナイーブな実装のため少々過剰なロックとなっています．実際の競合リソースに根ざした排他制御ができるよう，将来のバージョンで変更がなされる可能性もあります．}\KLUDGE ．

\KLUDGE 次に，Python\KLUDGE インタプリタ初期化用の関数を定義します．
\begin{sourcecode}
void EPLoopInit(void* arg) {
  PythonSprApp* app = (PythonSprApp*)arg;

  // Pythonでモジュールの使用宣言
  PyRun_SimpleString("import Spr");
        
  // PythonからCの変数にアクセス可能にする準備
  PyObject *m = PyImport_AddModule("__main__");
  PyObject *dict = PyModule_GetDict(m);

  // PythonからfwSceneにアクセス可能にする
  PyObject* pyObj = (PyObject*)newEPFWSceneIf(app->fwScene);
  Py_INCREF(pyObj);
  PyDict_SetItemString(dict, "fwScene", pyObj);

  // Pythonファイルをロードして実行する
  if (app->argc == 2) {
    ostringstream loadfile;
    loadfile << "__mainfilename__ ='";
    loadfile << app->argv[1];
    loadfile << "'";
    PyRun_SimpleString("import codecs");
    PyRun_SimpleString(loadfile.str().c_str());
    PyRun_SimpleString(
      "__mainfile__ = codecs.open(__mainfilename__,'r','utf-8')");
    PyRun_SimpleString(
      "exec(compile( __mainfile__.read() , __mainfilename__, 'exec')"
      ",globals()"
      ",locals())" );
    PyRun_SimpleString("__mainfile__.close()");
  }
}
\end{sourcecode}
\KLUDGE この関数は関数ポインタの形でインタプリタオブジェクトに渡され，実行開始時にコールバックされます．
\KLUDGE 中身はPython\KLUDGE 上でSpringhead\KLUDGE を使用可能にするための手続きと，C\KLUDGE 上の変数をブリッジするためのコード，そして起動時に指定された.py\KLUDGE ファイルをロードするコードなどです．

\KLUDGE 上の例では\texttt{app->fwScene}\KLUDGE のみをPython\KLUDGE に渡していますが，他にも受け渡したい変数が複数出てきた場合は，以下のようなマクロが便利でしょう．
\begin{sourcecode}
#define ACCESS_SPR_FROM_PY(cls, name, obj)           \
{                                                    \
    PyObject* pyObj = (PyObject*)newEP##cls((obj));  \
    Py_INCREF(pyObj);                                \
    PyDict_SetItemString(dict, #name, pyObj);        \
}                                                    \

// 使い方:
// ACCESS_SPR_FROM_PY(型名, Python側での変数名, アクセスする変数)
ACCESS_SPR_FROM_PY(FWSceneIf, fwScene, app->fwScene);
\end{sourcecode}
\KLUDGE 実際のPythonSpr\KLUDGE サンプルでは，このマクロを用いていくつかの変数をPython\KLUDGE から呼び出せるようにしています．

\KLUDGE ループ関数も定義します．これについては変更することは稀でしょう．
\begin{sourcecode}
void EPLoop(void* arg) {
	PyRun_InteractiveLoop(stdin,"SpringheadPython Console");
}
\end{sourcecode}

\KLUDGE 最後に，\texttt{main}\KLUDGE 関数内でPython\KLUDGE インタプリタクラスである\texttt{EPInterpreter}\KLUDGE を作成してコールバックを設定し，初期化・実行を行います．
\begin{sourcecode}
int main(int argc, char *argv[]) {
  app.Init(argc, argv);

  EPInterpreter* interpreter = EPInterpreter::Create();
  interpreter->Initialize();
  interpreter->EPLoopInit = EPLoopInit;
  interpreter->EPLoop = EPLoop;
  interpreter->Run(&app);

  app.StartMainLoop();
  return 0;
}
\end{sourcecode}





% ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- 
% \KLUDGE 詳細b
\subsection*{Python\KLUDGE へのSpringhead\KLUDGE 組込み}

Python\KLUDGE のDLL\KLUDGE インポート機能を利用してSpringhead\KLUDGE をPython\KLUDGE にロードして用いることができます．

Springhead\KLUDGE の機能は\texttt{Spr.pyd}\KLUDGE というDLL\KLUDGE ファイルにまとめられています．\texttt{Spr.pyd}\KLUDGE は，\path{bin\win32\Spr.pyd}\KLUDGE または\path{bin\win64\Spr.pyd}\KLUDGE としてSpringhead\KLUDGE リリースに含まれていますが，\path{src\EmbPython\SprPythonDLL.sln}\KLUDGE をビルドして生成することもできます．

\subsubsection*{\texttt{Spr.pyd}\KLUDGE の使い方}

\texttt{Spr.pyd} \KLUDGE は，Python\KLUDGE のインストールフォルダ内にある\texttt{DLLs}\KLUDGE フォルダにコピーして用います．

import\KLUDGE でロードします．
\begin{sourcecode}
Python 3.2.2 [MSC v.1500 64 bit (AMD64)] on win32
Type "help", "copyright", "credits" or "license" for more information.
>>> import Spr
\end{sourcecode}

Springhead\KLUDGE アプリケーションに組み込む場合と違い，ロード時点では何のオブジェクトも生成されていません．まず\texttt{PHSdk}\KLUDGE を生成し，次に\texttt{PHScene}\KLUDGE を生成することで，\texttt{PHSolid}\KLUDGE が生成できるようになります．
\begin{sourcecode}
>>> phSdk = Spr.PHSdk.CreateSdk()
>>> phScene = phSdk.CreateScene(Spr.PHSceneDesc())
>>> solid0 = phScene.CreateSolid(Spr.PHSolidDesc())
>>> for i in range(0,10):
...     print(solid0.GetPose().getPos())
...     phScene.Step()
... 
Vec3d(0.000,0.000,0.000)
Vec3d(0.000,-0.000,0.000)
Vec3d(0.000,-0.001,0.000)
...(中略)...
Vec3d(0.000,-0.011,0.000)
>>>
\end{sourcecode}

API\KLUDGE の呼び出し方はSpringhead\KLUDGE アプリケーション組み込みの場合と変わりません．
\KLUDGE ただし，この状態ではグラフィクス表示が使えないため出力はテキストやファイルに限られます．
\KLUDGE グラフィクス表示を使うためには，pyopengl\KLUDGE 等の描画ライブラリと組み合わせるコードを書く必要があります．


\subsubsection*{\KLUDGE 応用例}

\texttt{Spr.pyd}\KLUDGE の応用例の一つにSprBlender\KLUDGE があります．

\begin{center}
\epsopt{epsprblender}{width=0.5\hsize}
\end{center}

SprBlender\KLUDGE は，3DCG\KLUDGE ソフトBlender\KLUDGE にロードすることでSpringhead\KLUDGE を使用可能にする拡張機能で，Springhead\KLUDGE 開発チームによって公式に開発されています．

Blender\KLUDGE はUI\KLUDGE 機能の大半がPython\KLUDGE で記述されており，公開されたPython API\KLUDGE を通じて各種の機能を利用することができます．
\KLUDGE そこで，Blender\KLUDGE 上のPython\KLUDGE で\texttt{Spr.pyd}\KLUDGE をロードし，Blender\KLUDGE 上のCG\KLUDGE オブジェクトをSpringhead\KLUDGE でシミュレーションできるように書かれたPython\KLUDGE スクリプトがSprBlender\KLUDGE です．

\KLUDGE 詳しくはWeb\KLUDGE サイト\footnote{\url{http://springhead.info/wiki/SprBlender}}\KLUDGE を参照してください．



% ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- -----
%
% \KLUDGE 詳細２
% 
\section{Python\KLUDGE からのSpringhead API\KLUDGE 使用法}
\label{sec_pythonsprAPI}

% ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- 
% \KLUDGE 概説

Python\KLUDGE からSpringhead API\KLUDGE を呼び出す際の詳細な方法といくつかの注意点について解説します．

% ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- 
% \KLUDGE 詳細a
\subsubsection*{Spr\KLUDGE モジュールについて}

Springhead\KLUDGE の全クラスは\texttt{Spr}\KLUDGE モジュールにパッケージされています．
\begin{sourcecode}
import Spr
\end{sourcecode}
\KLUDGE を行うことで使用可能となります（Springhead\KLUDGE アプリケーションに組み込む場合は\texttt{EPLoopInit}\KLUDGE の中でインポートを実行します）．

Springhead\KLUDGE に関連するクラスは全てSpr\KLUDGE モジュールの直下に定義されます．Springhead\KLUDGE のインタフェースクラスはクラス名からIf\KLUDGE を取ったもの(\texttt{*****If}\KLUDGE →\texttt{*****})\KLUDGE ，ベクトルやクォータニオン等はそのままのクラス名で定義されています．

\KLUDGE 現時点では，すべてのSpringhead\KLUDGE クラスがPython\KLUDGE からの利用に対応しているわけではありません．Python\KLUDGE から利用できるSpringhead\KLUDGE クラスは，\texttt{dir}\KLUDGE 関数で確認できます．
\begin{sourcecode}
>>> import Spr
>>> dir(Spr)
\end{sourcecode}


% ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- 
% \KLUDGE 詳細b
\subsubsection*{\KLUDGE オブジェクトの生成}

C++\KLUDGE でSpringhead\KLUDGE を利用する場合と同様，まずはSdk\KLUDGE を作成する必要があります．Sdk\KLUDGE を作成するには，PHSdk\KLUDGE クラスのインスタンスから\texttt{CreateSdk}\KLUDGE を呼び出す必要があります．
\begin{sourcecode}
phSdk = Spr.PHSdk().CreateSdk()
grSdk = Spr.GRSdk().CreateSdk()
# ... etc.
\end{sourcecode}
% \KLUDGE ・・・なぜ？？？

\KLUDGE シーンのCreate\KLUDGE はSpringhead\KLUDGE 同様sdk\KLUDGE のインスタンスから行います．
\begin{sourcecode}
phScene = phSdk.CreateScene(Spr.PHSceneDesc())
grScene = grSdk.CreateScene(Spr.GRSceneDesc())
# ... etc.
\end{sourcecode}

% ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- 
% \KLUDGE 詳細b
\subsubsection*{IfInfo\KLUDGE ，自動ダウンキャスト}

\KLUDGE オブジェクトをCreate\KLUDGE するAPI\KLUDGE の中には，引き渡すディスクリプタの型によって生成するオブジェクトの種類を判別するものがあります．例えば\texttt{PHScene::CreateJoint}\KLUDGE は，\texttt{PHHingeJointDesc}\KLUDGE を渡すとヒンジジョイントを生成し，\texttt{PHBallJointDesc}\KLUDGE を渡すとボールジョイントを生成します．

\KLUDGE これらのCreate\KLUDGE 関数をPython\KLUDGE から利用する場合，ディスクリプタの型を判別する機能は現時点では用意されていないため，生成したいオブジェクトの型に対応するIfInfo\KLUDGE オブジェクトを同時に引数に渡します．
\begin{sourcecode}
# Hinge
phScene.CreateJoint(so1,so2, Spr.PHHingeJoint.GetIfInfoStatic(), desc)

# Ball
phScene.CreateJoint(so1,so2, Spr.PHBallJoint.GetIfInfoStatic(),  desc)
\end{sourcecode} 
IfInfo\KLUDGE オブジェクトは\texttt{\KLUDGE クラス名.GetIfInfoStatic()}\KLUDGE で取得することができます．

\KLUDGE より正確には，ディスクリプタ型によって返すオブジェクトを変えるようなCreate\KLUDGE 関数は，以下のようにAPI\KLUDGE ヘッダファイルにおいてテンプレートを用いて記述されています．Python API\KLUDGE では，非テンプレート版のCreate\KLUDGE 関数のみがポートされているため，\texttt{IfInfo* ii} \KLUDGE に相当する引数が必要になります．
\begin{sourcecode}
// in SprPHScene.h
PHJointIf* CreateJoint(PHSolidIf* lhs, PHSolidIf* rhs,
  const IfInfo* ii, const PHJointDesc& desc);

template <class T> PHJointIf* CreateJoint
(PHSolidIf* lhs, PHSolidIf* rhs, const T& desc){
  return CreateJoint(lhs, rhs, T::GetIfInfo(), desc);
}
\end{sourcecode}

\KLUDGE なお，複数種類のクラスのオブジェクトを返しうるAPI\KLUDGE 関数の場合，C++\KLUDGE では共通するスーパークラス(\KLUDGE 関節なら\texttt{PHJointIf}\KLUDGE など)\KLUDGE が返るため自分で\texttt{DCAST}\KLUDGE 等を用いてダウンキャストする必要がありますが，Python\KLUDGE においてははじめから個々のクラス(\texttt{PHHingeJoint}, \texttt{PHBallJoint}\KLUDGE など)\KLUDGE の型情報を持つように自動的にダウンキャストされたものが返されます．よって，ユーザが意識してダウンキャストする必要はありません．


% ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- 
% \KLUDGE 詳細c
\subsubsection*{enum\KLUDGE の扱い}

\texttt{PHSceneIf::SetContactMode}\KLUDGE のように，enum\KLUDGE 型を引数にとる関数があります．
\KLUDGE 残念ながら，現時点ではenum\KLUDGE の定義はPython\KLUDGE へポートされていません．これらの関数を呼び出す場合は，対応する整数値を渡してください．
\begin{sourcecode}
# C++での phScene->SetContactMode(so1, so2, PHSceneDesc::MODE_NONE) と同じ
phScene.SetContactMode(so1, so2, 0)
\end{sourcecode}


% ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- ----- 
% \KLUDGE 詳細d
\subsubsection*{\KLUDGE ベクトル，ポーズ}

\texttt{Vec3d}\KLUDGE ，\texttt{Quaterniond}\KLUDGE ，\texttt{Posed}\KLUDGE 等はSpringhead\KLUDGE と同じクラス名で使用できます．
\KLUDGE 各要素は \texttt{.x} \texttt{.y} \KLUDGE 等のプロパティによりアクセスでき，値の変更も可能です．

\begin{sourcecode}
>>> v = Spr.Vec3d(1,2,3)
>>> v
(1.000,2.000,3.000)
>>> v.x
1.0
>>> v.x = 4.0
>>> v
(4.000,2.000,3.000)
\end{sourcecode}

\texttt{Posed}, \texttt{Posef}\KLUDGE については，\texttt{w, x, y, z}\KLUDGE プロパティがクォータニオン成分，\texttt{px, py, pz}\KLUDGE プロパティがベクトル成分へのアクセスとなります．
\KLUDGE また，\texttt{Posed::Pos()}, \texttt{Posed::Ori()}\KLUDGE に対応する関数として
\begin{itemize}
\item \texttt{.getOri()}
\item \texttt{.setOri()}
\item \texttt{.getPos()}
\item \texttt{.setPos()}
\end{itemize}
\KLUDGE が用意されています．



