% 5.4.11.BuildAndRun.tex
%	Last update: 2018/06/07 F.Kanehori
%\newpage
\subsubsection{BuildAndRun}
\label{subsubsec:BuildAndRun}


\medskip
\noindent
\bf{概要}


\begin{narrow}[20pt]
Solution/makeファイルで指定された1つのソリューションについて、
コンパイル及びテスト実行を実施するクラス。
この時点で、コンパイル及びテスト実行に係るパラメータはすべて確定していること。

コンパイルには、Visual Studio(Windowsの場合)又は\TT{/bin/make}(unixの場合)を使用する。
テスト実行は、生成されたバイナリを直接起動することで実施する。
それぞれ、リターンコードを返すことで結果を通知する。
\end{narrow}

\bigskip
\noindent
\bf{イニシャライザ} (\tt{__init__})

\vspace{5pt}
\begin{narrow}[20pt]
    \framebox[\linewidth][l]{%
	\begin{tabular}{l}
	    \tt{obj = BuildAndRun(ccver, verbose, dry_run)}
	\end{tabular}}

    \medskip
    引数
    \begin{narrow}[20pt]
	\vspace{-10pt}
	\def\COLWID{275pt}
	\begin{longtable}{p{35pt}l}
	    \tt{ccver}	 & \begin{parcol}{\COLWID}{%
		コンパイラのバージョン (unixの場合はダミー)\\
		Visual Studioのtool set versionを指定
		(\REF{subsubsec}{VisualStudio})。
	    }\end{parcol}\\
	    \tt{dry_run} & \begin{parcol}{\COLWID}{%
		コマンドを表示するだけで実行はしない
	    }\end{parcol}
	\end{longtable}
    \end{narrow}
\end{narrow}

%\bigskip
\noindent
\bf{公開メソッド}


\vspace{5pt}
\def\COLWID{255pt}
\begin{enumerate}
  \item	\tt{build(build(dirpath, slnfile, platform, opts, \CONT}\\
		\hspace{100pt}\tt{outfile, logfile, errlogfile, force=False)}\\
	引数
	\begin{narrow}[20pt]
	    \begin{longtable}{p{50pt}l}
		\tt{dirpath}
		    & \begin{parcol}{\COLWID}{%
			ソリューションファイルがあるディレクトリのパス名
		      }\end{parcol}\\
		\tt{slnfile}
		    & \begin{parcol}{\COLWID}{%
			Solution/makeファイル名
		      }\end{parcol}\\
		\tt{platform}
		    & \begin{parcol}{\COLWID}{%
			プラットフォーム(\TT{x86, x64})
		      }\end{parcol}\\
		\tt{opts}
		    & \begin{parcol}{\COLWID}{%
			コンパイラオプション\\
			\hspace{10pt}Windows \RARROW\ (\tt{Debug, Release, Trace})\\
			\hspace{10pt}unix \RARROW\ (\TT{-g, -O2})
		      }\end{parcol}\\
		\tt{outfile}
		    & \begin{parcol}{\COLWID}{%
			出力バイナリのパス
			(Windowsの場合leaf名はダミー --- solution fileで決まる)\\
			絶対パス又は\TT{dirpath}からの相対パスで指定する。
		      }\end{parcol}\\
		\tt{logfile}
		    & \begin{parcol}{\COLWID}{%
			ログファイルのパス(ログはappendされる）\\
			絶対パス又は\TT{dirpath}からの相対パスで指定する。
		      }\end{parcol}\\
		\tt{errlogfile}
		    & \begin{parcol}{\COLWID}{%
			エラーログファイルのパス(ログはappendされる）\\
			絶対パス又は\TT{dirpath}からの相対パスで指定する。
		      }\end{parcol}\\
		\tt{force}
		    & \begin{parcol}{\COLWID}{%
			強制的に再コンパイルする(True or False)
		      }\end{parcol}\\
	    \end{longtable}
	\end{narrow}

	\vspace{-10pt}
	概要
	\begin{narrow}[20pt]
		一時的に指定されたディレクトリ(\TT{dirpath})に移動して
		ソリューションをコンパイルする。
	\end{narrow}
	\medskip

	処理の説明
	\begin{narrow}[20pt]
		\begin{enumerate}
		  \item	引数\ARG{dirpath}で指定されたディレクトリに移動する。

		  \item	ログファイル、エラーログファイルをappend openする。
			コンパイルログをこれらのファイルに直接書き出せる訳ではない
			(後でマージする)。

		  \item	Windowsの場合は\METHOD{__build_w()}を、
			unixの場合は\METHOD{__build_u()}を呼び出してコンパイルする。
			引数は煩雑になるのでリストにまとめてある。

		  \item	コンパイルログからエラー行を抜き出す。

		  \item	コンパイルログをログファイルに、
			前項で抜き出したエラー行をエラーログファイルにマージする。

		  \item	元のディレクトリに戻って、コンパイル結果(status code)を返す。
	    \end{enumerate}
	\end{narrow}

  \item	\tt{run(build(dirpath, exefile, args, logfile, errlogfile, \CONT}\\
		\hspace{100pt}\tt{addpath, timeout, pipeprocess)}\\
	引数
	\begin{narrow}[20pt]
	    \begin{longtable}{p{50pt}l}
		\tt{dirpath}
		    & \begin{parcol}{\COLWID}{%
			生成したバイナリファイルがあるディレクトリのパス名
		      }\end{parcol}\\
		\tt{exefile}
		    & \begin{parcol}{\COLWID}{%
			Windows \RARROW\ 実行バイナリのパス\\
			unix \RARROW\ makefileのパス
		      }\end{parcol}\\
		\tt{args}
		    & \begin{parcol}{\COLWID}{%
			実行時に与える引数
		      }\end{parcol}\\
		\tt{args}
		    & \begin{parcol}{\COLWID}{%
			実行時に与える引数
		      }\end{parcol}\\
		\tt{logfile}
		    & \begin{parcol}{\COLWID}{%
			ログファイルのパス(ログはappendされる）\\
			絶対パス又は\TT{dirpath}からの相対パスで指定する。
		      }\end{parcol}\\
		\tt{errlogfile}
		    & \begin{parcol}{\COLWID}{%
			エラーログファイルのパス(ログはappendされる）\\
			絶対パス又は\TT{dirpath}からの相対パスで指定する。
		      }\end{parcol}\\
		\tt{addpath}
		    & \begin{parcol}{\COLWID}{%
			実行時サーチパスに加えるパス(前置される)。
		      }\end{parcol}\\
		\tt{timeout}
		    & \begin{parcol}{\COLWID}{%
			実行時のタイムアウト値(秒)。
		      }\end{parcol}\\
		\tt{pipeprocess}
		    & \begin{parcol}{\COLWID}{%
			実行バイナリの標準入力に何か与える必要がある場合、
			それを与えるプログラム。
		      }\end{parcol}\\
	    \end{longtable}
	\end{narrow}

	\vspace{-10pt}
	概要
	\begin{narrow}[20pt]
		一時的に指定されたディレクトリ(\TT{dirpath})に移動して
		プログラムを実行する。
		パイププロセスを指定することも可能で(ただし入力側のみ)。
		これは、メニュー駆動のプログラムを想定したものである。
		(出力側のパイププロセスは指定できない)\\
		\footnotesize{\begin{tabular}{r@{\hspace{0pt}}l}
		※ & \begin{parcol}{310pt}
 			Webのレポートでは単純にdiffをとっているものがあるが、
			出力をフィルタリングしてからdiffをとった方が見易くなると
			思われるので拡張を考慮する価値はある -- (TODO)。
		     \end{parcol}
		\end{tabular}}
	\end{narrow}
	\medskip

	処理の説明
	\begin{narrow}[20pt]
		\begin{enumerate}
		  \item	引数\ARG{dirpath}で指定されたディレクトリに移動する。

		  \item	実行ログを書き出す一時ファイル名を決める。

		  \item	ログファイル、エラーログファイルをappend openする。
			実行ログをこれらのファイルに直接書き出せる訳ではない
			(後でマージする)。

		  \item	unixの場合、makeのターゲットを\TT{test}とする。

		  \item	\tT{Proc}クラスを用いてプログラムを実行する
			(パイププロセスの処理も行なう)。
			プロセスの出力は実行ログ一時ファイルに割り当てる
			(標準出力、標準エラーとも)。
			\TT{timeout}は\METHOD{wait()}の引数として指定する。

		  \item	実行一時ログからエラー行を抜き出す。

		  \item	実行一時ログをログファイルに、
			前項で抜き出したエラー行をエラーログファイルにマージする。

		  \item	元のディレクトリに戻って、実行結果(status code)を返す。
	    \end{enumerate}
	\end{narrow}
	\medskip
\end{enumerate}

\bigskip
\noindent
\bf{内部メソッド \rm{(抜粋)}}

\vspace{5pt}
\def\COLWID{280pt}
\begin{enumerate}
  \item	\tt{__open_log(self, fname, fmode, step)}\\
	概要
	\begin{narrow}[20pt]
		指定されたファイルを指定されたモードでオープンする。
	\end{narrow}
	\medskip

  \item	\tt{__build_u(args)}\\
	概要
	\begin{narrow}[20pt]
		Unix用のコンパイルメソッド。
		コンパイルの方法はmakefileで指定する。\\
		\begin{enumerate}
		  \item	引数\ARG{args}(リスト)を、
			\TT{slnfile, platform, opts, outfile, force}に分解する。

		  \item	コンパイルログを書き出す一時ファイル名を決める。

		  \item	\TT{Proc}クラスを用いてコンパイルを実行する
			(パイププロセスの処理も行なう)。
			プロセスの出力はログ一時ファイルに割り当てる
			(stdout, stderrとも)。\\
			\CMND{0pt}{make -f <\IT{makefile}> compile}{0pt}

		  \item	コンパイル結果とログ情報とを返す。\\
			\begin{tabular}{@{\hspace{10pt}}lcl}
				コンパイル結果	& \RARROW & status code\\
				ログ情報	& \RARROW & コマンド名とログ一時ファイル名
			\end{tabular}
		\end{enumerate}
	\end{narrow}
	\medskip

  \item	\tt{__build_w(args)}\\
	概要
	\begin{narrow}[20pt]
		Windows用のコンパイルメソッド。
		コンパイルにはVisual Studioを用いる(\REF{subsubsec}{VisualStudio})。
		\begin{enumerate}
		  \item	引数\ARG{args}(リスト)を、
			\TT{slnfile, platform, opts, outfile, force}に分解する。

		  \item	実行ログを書き出す一時ファイル名を決める。

		  \item	クラス\TT{VisualStudio}のインスタンスを生成し(\tt{vs})、
			必要なパラメータを設定する(\METHOD{vs.set()})。

		  \item	\TT{Proc}クラスを用いてコンパイルを実行する
			\CMND{0pt}{vs.build()}{0pt}

		  \item	コンパイル結果とログ情報とを返す。\\
			\begin{tabular}{@{\hspace{10pt}}lcl}
				コンパイル結果	& \RARROW & status code\\
				ログ情報	& \RARROW & コマンド名とログ一時ファイル名
			\end{tabular}
		\end{enumerate}
	\end{narrow}
	\medskip

  \item	\tt{__select_errors(fname, step)}\\
	概要
	\begin{narrow}[20pt]
		指定されたファイルを読み、\TT{" error "}を含む行を集めてリストとして返す。
	\end{narrow}
	\medskip

  \item	\tt{__merge_log(self, kind, data, logf, cmnd, step)}\\
	概要
	\begin{narrow}[20pt]
		引数\ARG{kind}の意味は次の通り。\\
		\begin{tabular}{@{\hspace{10pt}}lcl}
			1 & \RARROW & 次の引数\ARG{DATA}はログテキストのリストである。\\
			2 & \RARROW & ログテキストを記録したファイル名である。
		\end{tabular}\\
		これに従ってログテキストを取得し、引数\ARG{logf}で与えられた
		ファイルオブジェクトに追記する(オープン済みのオブジェクト)。
	\end{narrow}
	\medskip
\end{enumerate}

% end: 5.4.11.BuildAndRun.tex
