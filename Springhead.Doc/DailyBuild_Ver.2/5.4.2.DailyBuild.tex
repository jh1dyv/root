% 5.4.2.DailyBuild.tex
%	Last update: 2018/06/18 F.Kanehori
%\newpage
\subsubsection{DailyBuild}
\label{subsubsec:DailyBuild}

\medskip
\noindent
DailyBuildに関連するリポジトリSpringhead及びDailyBuild/Resultを
最新の状態にする処理(\ref{subsec:DailyBuildEnvironmentVariable}
DailyBuildEnvironmentVariableで示したstep 1.からstep 3.に相当)を実行する
プログラム。
step 4.以降の処理は、ここから\tt{TestMainGit}を呼出して実行させる。

\bigskip
\noindent
起動方法
\Cmnd{4pt}{python DailyBuild.py [options] test-repository result-repository}{-8pt}

\begin{CmndOpts}[5em]
    \CmndOpt{-c CONF}{ビルド構成 (\tt{Debug, Release\NOTE, Trace})}
    \CmndOpt{-p PLAT}{プラットフォーム (\tt{x86, x64\NOTE})}
    \CmndOpt{-t TOOL}{ツールセット (\tt{14.0\NOTE})}
    \CmndOpt{-u}{step 1.のみ実行して終了する}
    \CmndOpt{-U}{step 2.以降のみ実行する}
    \CmndOpt{-A}{step 3.以降のみ実行する}
    \CmndOpt{-D}{コマンドを表示するだけで実行はしない(dry run)}
\end{CmndOpts}

\begin{CmndArgs}[4em]
    \MC{2}{l}{\tt{test-repository}}\\
    \CmndArg{}{%
 	テストレポジトリ\\
	任意のディレクトリでよいが、既存のディレクトリの場合には、
	その内容はすべて破棄される。
	通常\Path{SpringheadTest}を指定する。}
    \MC{2}{l}{\tt{result-repository}}\\
    \CmndArg{}{%
    	テスト結果記録用レポジトリ\\
	通常\Path{DailyBuildResult/Result}を指定する。}
\end{CmndArgs}
\begin{narrow}[s][\WID]\begin{Table}[r][1em]{ll}
    \Item{※}{%
    	これらのディレクトリは、
	テストを起動するディレクトリから3階層上のディレクトリ
	(例えば\Path{top/Springhead/core/test}ならば\Path{top})からの
	相対パスで指定すること。}
\end{Table}\end{narrow}

\vspace{-1.5\baselineskip}
\framebox{\begin{tabular}{l}\begin{minipage}[t]{\linewidth}
	\bf{(注意)}　第2引数で指定した``テスト結果記録用レポジトリ''へ
	pushするためのアクセス権を得るために、
	\tt{git.haselab.net}のユーザ名及びパスワードを記録したファイル
	\Path{I:/DailyBuild/hasegit.user}を参照している。
	コマンドラインからのアクセスでパスワードを指定しなくてもよい方法が
	見つけられるまで、このファイルを移動したり削除したりしないこと。
	もちろんこのファイルは公開してはならない。
\end{minipage}\end{tabular}}

\bigskip
\noindent
ステップ毎の処理

\begin{narrow}[\WID]\begin{description}
  \item	[step 1.]
	レポジトリSpringhead及びDailyBuildResult/Resultを最新の状態にする。\\
    	\Cmnd{-10pt}{git pull --all}{-8pt}\\
	(このコマンドは、それぞれのレポジトリ内(gitの配下)で実行する必要がある。)
	オプション\tt{-U}が指定されたならば、このstepは実行しない。
	オプション\tt{-u}が指定されたならば、ここでプログラムを終了する。
	\medskip

  \item	[step 2.]
	テストレポジトリを削除する。
	これは毎回スクラッチからテストを実行するためである。
	\medskip

  \item	[step 3.]
	テスト用レポジトリをcloneする。使用するコマンドは\\
	\Cmnd{-10pt}{%
	    \begin{tabular}{l}
		git clone --recurse-submodules \CONT\\
		    \hspace{30pt}
		    https://github.com/sprphys/Springhead SpringheadTest\\
		git submodule update --init\\
		\end{tabular}}
	    {0pt}
	\medskip

  \item	[step 4.以降]
	テストレポジトリのテストディレクトリ
	\Path{("SpringheadTest/core/test")}へ移動し、
	そこで\TT{TestMainGit}を実行する。\\
	\Cmnd{-10pt}{%
	    \begin{tabular}{l}
		python TestMainGit.py -p x64 -c Release -t 14.0 \CONT\\
		    \hspace{30pt}
		    SpringheadTest DailyBuildResult/Result\\
	    \end{tabular}}
	    {0pt}
	\medskip
\end{description}\end{narrow}

% end: 5.4.2.DailyBuild.tex
