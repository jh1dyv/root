% 5.4.4.SpringheadTest.tex
%	Last update: 2018/05/24 F.Kanehori
%\newpage
\subsubsection{SpringheadTest}
\label{subsubsec:SpringheadTest}

\medskip
引数で指定されたディレクトリ以下すべてのサブディレクトリを対象として
テストを実施するためのプログラム。
どのサブディレクトリに対してどのようなテストを実施するかは、
各ディレクトリに配置されたテスト制御ファイル \FILE{dailybuild.control} で制御する。
制御方法の詳細については \ref{subsubsec:ControlParams} ControlProgram及び\ 
\ref{subsubsec:ConstDefs} ConstDefsを参照のこと。

\bigskip
\noindent
起動方法
\CMND{4pt}{python SpringheadTest.py [options] test-dir res-file ctl-file section}{-2pt}

\noindent
options \small{( $^\dagger$はデフォルトを示す)}
\vspace{3pt}
\begin{narrow}[20pt]
    \begin{tabular}{ll}
	\tt{-c CONF}	& ビルド構成 (\tt{Debug, Release, Trace})\\
	\tt{-p PLAT}	& プラットフォーム (\tt{x86, x64})\\
	\tt{-r}		& 強制的にビルドする\\
	\tt{-s}		& プログレスレポートをしない\\
	\tt{-t TOOL}	& ツールセット (\tt{14.0$^\dagger$})\\
	\tt{-C usage}	& Closed sourceの扱い方\\
			& \begin{tabular}{@{\hspace{15pt}}ll}
			    \tt{auto}	& テスト制御ファイルに従う\\
			    \tt{use}	& 無条件に使用する\\
			    \tt{unuse}	& 無条件に使用しない
			\end{tabular}\\
	\tt{-D}	& コマンドを表示するだけで実行はしない(dry run)\\
	\tt{-S} & テスト結果累積ファイルを初期化する\\
	\tt{-T value}	& 実行タイムアウト指定 (単位は秒)\\
    \end{tabular}
\end{narrow}

\medskip
\noindent
引数
\begin{narrow}[20pt]
    \begin{tabular}{ll}
	\tt{test-dir}	& テスト対象ディレクトリ\\
			& \footnotesize{\begin{tabular}{l}
				※ テストを起動するディレクトリから1階層上の
				   ディレクトリからの相対パスで指定。\\
				\phantom{※ }(例えば\FILE{core/test}ならば
					     \FILE{core}からの相対パス)
			  \end{tabular}}\\
	\tt{res-file}	& テスト結果累積ファイル名\\
			& \footnotesize{\begin{tabular}{l}
				※ テストを起動するディレクトリからの相対パスで指定。
			  \end{tabular}}\\
	\tt{ctl-file}	& テスト制御ファイル名\\
	\tt{section}	& テスト制御ファイルの対象セクション名\\
			& \tt{Windows}または\tt{unix}を指定
    \end{tabular}
\end{narrow}

\medskip
\noindent
処理の説明

\begin{enumerate}
  \item	テストディレクトリ\TT{core/test}に移動する。
	\medskip

  \item	\tt{TestResult}クラスを生成して、テスト結果累積データを準備する。\\
	\CMND{-8pt}{res = TestResult(res_file, scratch, verbose=1)}{-20pt}\\
	\begin{narrow}[10pt]
		Springheadライブラリ作成時には起動引数\TT{-S}が指定され、
		テスト結果累積データは空に初期化される。
		\tt{src/tests}, \tt{src/Samples}のテスト時には
		起動引数\TT{-S}は指定されず、
		テスト結果累積データは\TT{res_file}の内容で初期化される。
		いずれの場合も、今回のテスト結果はそれに追加される。
	\end{narrow}
	\medskip

  \item	\tt{ClosedSrcControl}クラスを生成して、Closed sourceの使用/不使用の
	準備をする。
	ここでは関連するファイルを指定しておくだけで、ヘッダファイル\IT{csc_head}を
	変更する訳ではない。\\
	\CMND{-8pt}
	     {csc = ClosedSrcControl(csc_head, use_tmpl, unuse_tmpl, dry_run, verbose)}
	     {-20pt}\\
	\begin{narrow}[10pt]
		最初の3つの引数は、ビルド時にincludeされるマクロファイル名、
		closed source使用時のためのテンプレートファイル名、
		closed source不使用時のためのテンプレートファイル名である。
		実際のファイル名は、\\
		\hspace{20pt}\FILE{core/include/UseClosedSrcOrNot.h}\\
		\hspace{20pt}\FILE{core/test/bin/UseClosedSrc.h.template}\\
		\hspace{20pt}\FILE{core/test/bin/UnuseClosedSrc.h.template}\\
		である。
	\end{narrow}
	\medskip

  \item	\tt{Traverse}クラスを生成して必要なパラメータを設定し、テスト実行の準備をする。\\
	\CMND{-6pt}{%
		\hspace{-10pt}
		\begin{tabular}{l}
		    trv = Traverse(testid, res, csc, ctl_file, section,\CONT\\
		    \hspace{50pt}toolset, platforms, configs, csusage, rebuild,\CONT\\
		    \hspace{50pt}timeout, report, audit, dry_run, verbose)\\
		\end{tabular}}
		{-15pt}\\
	\begin{narrow}[10pt]
		\tt{testid}には引数\TT{test-dir}に従い次の\TT{TESTID}クラス定数を
		設定する。\\
		\small{\begin{tabular}{@{\hspace{20pt}}ll}
			Springheadライブラリ作成のとき & \tt{TESTID.STUB}\\
			\tT{src/tests}のテストのとき   & \tt{TESTID.TESTS}\\
			\tT{src/Samples}のテストのとき & \tt{TESTID.SAMPLES}
		\end{tabular}}\\
		\Tt{res}, \tT{csc}は前のステップで生成したクラスオブジェクトである。
		他のパラメータは、起動時引数及びオプションを参照して設定する。
		ただし\TT{csusage}にはオプション\TT{-C}の値に従い次の\TT{TESTID}クラス
		定数を設定する(\REF{subsubsec}{ConstDefs})。\\
		\small{\begin{tabular}{@{\hspace{20pt}}ll}
			\tt{-C auto}	& \tt{TESTID.AUTO}\\
			\tt{-C use}	& \tt{TESTID.USE}\\
			\tt{-C unuse}	& \tt{TESTID.UNUSE}
		\end{tabular}}
	\end{narrow}
	\medskip

  \item	指定されたディレクトリに対して ビルド＆テストを実行する。\\
	\CMND{-8pt}{stat = trv.traverse(top)}{-20pt}\\
	\begin{narrow}[10pt]
		\tT{top}はテスト対象ディレクトリで、次のものを指定する。\\
		\small{\begin{tabular}{@{\hspace{20pt}}ll}
			Springheadライブラリ作成のとき & \FILE{src}\\
			\tT{src/tests}のテストのとき   & \FILE{src/tests}\\
			\tT{src/Samples}のテストのとき & \FILE{src/Samples}
		\end{tabular}}\\
	\end{narrow}
	\medskip

  \item	テスト結果をテスト結果累積ファイル\TT{res_file}に書き出す。\\
	\CMND{-8pt}{res.finish()}{-5pt}

  \item	\FILE{UseClosedSrcOrNot.h}の内容が変更されていたら元の状態に戻す。\\
	\CMND{-8pt}{csc.revice()}{-5pt}

  \item	テスト結果ファイル\FILE{result.log}を作成する。\\
	\CMND{-8pt}{python GenResultLog.py -o ../log/result.log
				\tt{res_file} \it{<plat\,> <conf\,>}}{-5pt}
	\begin{narrow}[10pt]
		\it{<plat\,>, <conf\,>}はそれぞれオプション\TT{-p, -c}で
		指定されたものである。
		オプションの仕様上は複数指定が可能であるが、
		タスクDailyBuildでは必ず単一指定にする
		(\FILE{result.log}はそのように仮定されている)
		\begin{narrow}[f]
			※ オプションの複数指定は、すべての構成・プラットフォーム
			に対するテストを実施するための仕掛けであり、その場合には
			\FILE{result.log}を作成することは意図されていない。
		\end{narrow}
	\end{narrow}

\end{enumerate}

% end: 5.4.4.SpringheadTest.tex
